<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../things-meta-view/things-diy-based-form.html">

<!--
OI Screen - Order List
-->

<dom-module id="things-term-start-lot">
	<template>
		<style>
			:host {
				display: block;
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}
      things-layout-hera {
        @apply(--layout-flex);
      }			
		</style>

		<things-ajax
			auto
			id="get-order"
			resource-action="find"
			resource-url="work_orders/:id"
			resource-id="[[orderId]]"
			last-response="{{order}}">
		</things-ajax>

		<things-ajax
			id="create-lot"
			resource-action="create"
			resource-url="lot_trxs/CREATE/transaction">
		</things-ajax>

		<things-ajax
			id="latest-lots"
			resource-action="index"
			resource-url="lots"
			limit="10"
			last-response="{{latestLots}}">
		</things-ajax>

    <things-layout-hera left-content-title="[[leftContentTitle]]" right-content-title="[[rightContentTitle]]">
      <things-diy-based-form
      	left
      	id="form"
      	class="flex"
      	resource="[[order]]"
      	resource-id="[[orderId]]"
      	diy-form-name="OI-StartLot">
      </things-diy-based-form>

      <things-diy-based-grid
      	right
      	class="flex"
      	diy-grid-name="OI-LatestLotList"
      	items="[[latestLots.items]]">
      </things-diy-based-grid>
    </things-layout-hera>

    <paper-toolbar justify="end">
      <things-button-bar id="button-bar" buttons="[[buttons]]">
      </things-button-bar>
    </paper-toolbar>
	</template>

	<script>
		Polymer({
			
			is: 'things-term-start-lot',

			properties: {
				/**
				 * 메뉴 정보
				 */
				menuInfo: {
					type: Object
				},

				/**
				 * 라우팅 정보
				 */
				dataRoute: {
					type: String,
					observer: 'dataRouteChanged'
				},

				/**
				 * 오더 아이디
				 */
				orderId: {
					type: String
				},

				/**
				 * 오더
				 */
				order: {
					type: Object,
					notify: true
				},

				/**
				 * 생성된 Lot
				 */
				lot: {
					type: Object
				},

				latestLots: {
					type: Object
				},

				/**
				* Buttons 리스트 설정
				*/
				buttons: {
					type: Array,
					value: [ {
						id: 'create-btn',
						text: 'create'
					}, {
						id: 'reset-btn',
						text: 'reset'
					} ]
				}
			},

			listeners: {
				'create-btn-tap' : 'createLot',
				'reset-btn-tap' : 'resetForm',
				'create-lot.things-ajax-response' : '_transactionResponsed',
			},

			/**
			 * dataRoute가 변경되었을 경우 
			 *
			 * @param {String} dataRoute
			 */
			dataRouteChanged: function(dataRoute) {
				if(dataRoute == this.menuInfo.routing) {
					this.orderId = Things.DataGlobal.order.id;
					this.$['latest-lots'].generateRequest();
					console.log(this.latestLots);
				}
			},

			/**
			 * Create Lot 
			 *
			 * @param {Object} event
			 */
			createLot: function(event) {
				var data = this.$['form'].getForm().serializeMyForm();
				var createAjax = this.$['create-lot'];
				createAjax.body = {
					work_order_id : this.orderId,
					comments : data.comments,
					operation_id : 40
				};

				createAjax.generateRequest();
			},

			/**
			 * Reset Form 
			 *
			 * @param {Object} event
			 */
			resetForm: function(event) {
				this.$['form'].getForm().resetMyForm();
				this.$['get-order'].generateRequest();
				this.$['latest-lots'].generateRequest();
			},

			/**
			 * 트랜잭션 성공시 
			 *
			 * @param {Object} event
			 */
			_transactionResponsed: function(event) {
				this.resetForm();
				this.lot = event.detail;
			}
		});
	</script>
</dom-module>