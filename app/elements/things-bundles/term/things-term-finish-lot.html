<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../../../bower_components/things-global-behavior/things-global-behavior.html">

<link rel="import" href="../../things-layout-view/things-layout-hermes.html">
<link rel="import" href="../../things-meta-view/things-diy-based-grid.html">
<link rel="import" href="../../things-meta-view/things-diy-based-form.html">

<!--
  OI - FINISH LOT 트랜잭션 
-->

<dom-module id="things-term-finish-lot">
  <template>
    <style>
      :host {
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      things-layout-hera {
        @apply(--layout-flex);
      }
    </style>

    <things-ajax
      id="find-lot"
      resource-action="create"
      resource-url="lot_trxs/VALIDATE_LOT/transaction"
      last-response="{{lot}}">
    </things-ajax>

    <things-ajax
      id="finish-lot"
      resource-action="create"
      resource-url="lot_trxs/FINISH/transaction">
    </things-ajax>

    <things-layout-hera left-content-title="[[leftContentTitle]]" right-content-title="[[rightContentTitle]]">
      <things-diy-based-form id='form' left class="flex" diy-form-name="OI-MoveLot" buttons="[[formButtons]]"></things-diy-based-form>
      <things-diy-based-grid id='grid' right class="flex" diy-grid-name="OI-LatestLotList"></things-diy-based-grid>
    </things-layout-hera>
  </template>

  <script>
    Polymer({
      is: 'things-term-finish-lot',

      properties: {
        /**
         * 메뉴 정보
         */
        menuInfo: {
          type: Object
        },

        /**
         * 라우팅 정보
         */
        dataRoute: {
          type: String
        },

        /**
         * Title Of Left Content
         */
        leftContentTitle: {
          type: String,
          value: 'Lot Information'
        },

        /**
         * Title Of Right Content
         */
        rightContentTitle: {
          type: String,
          value: 'Latest Lot List'
        },

        /**
         * 오더
         */
        order: {
          type: Object,
          notify: true
        },
        
        /**
         * 오더 아이디
         */
        orderId: {
          type: String
        },

        /**
         * Lot
         */
        lot: {
          type: Object,
          observer: '_lotChanged'
        },

        /**
         * Form 버튼 
         */
        formButtons: {
          type: Array,
          value: function() {
            return [ {
              id: 'search-btn',
              text: 'search'
            }, {
              id: 'process-btn',
              text: 'process'
            }, {
              id: 'reset-btn',
              text: 'reset'
            } ];
          }
        }
      },

      behaviors: [
        Things.GlobalBehavior
      ],

      observers: [
        'orderChanged(globals.order)',
      ],      

      listeners: {
        'search-btn-tap' : 'findLot',
        'process-btn-tap' : 'moveLot',
        'reset-btn-tap' : 'resetForm',
        'finish-lot.things-ajax-response' : '_transactionResponsed',
      },

      /**
       * Order 변경시 
       */
      orderChanged: function(order) {
        this.order = order;
        this.orderId = order.id;
      },      

      /** 
       * Find Lot 
       *
       * @param {Object} event
       */
      findLot: function(event) {
        var data = this.$['form'].getForm().serializeMyForm();
        var validateAjax = this.$['find-lot'];
        validateAjax.body = {
          lot_name : data.name,
          work_order_id : this.orderId,
          transaction : 'FINISH'
        };
        validateAjax.generateRequest();
      },

      /** 
       * Move Lot 
       *
       * @param {Object} event
       */
      moveLot: function(event) {
        var data = this.$['form'].getForm().serializeMyForm();
        var moveAjax = this.$['finish-lot'];
        moveAjax.body = {
          lot_id : data.id,
          comments : data.comments,
          operation_id : data.operation_id
        };

        moveAjax.generateRequest();
      },

      /**
       * Reset Form 
       *
       * @param {Object} event
       */
      resetForm: function(event) {
        this.$['form'].getForm().resetMyForm();
      },

      /**
       * Lot 조회시
       *
       * @param {Object} lot
       */
      _lotChanged: function(lot) {
        this.$['form'].getForm().setFormData(lot);
      },

      /**
       * 트랜잭션 성공시 
       *
       * @param {Object} event
       */
      _transactionResponsed: function(event) {
        this.resetForm();
      }
    });
  </script>
</dom-module>