<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../things-meta-view/things-diy-based-form.html">

<!--
OI Screen - Order List
-->

<dom-module id="things-term-create-lot">
	<template>
		<style>
			:host {
				display: block;
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}
      things-layout-hermes {
        @apply(--layout-flex);
      }			
		</style>

		<things-ajax
			auto
			id="get-order"
			resource-action="find"
			resource-url="work_orders/:id"
			resource-id="[[orderId]]"
			last-response="{{order}}">
		</things-ajax>

		<things-ajax
			id="create-lot"
			resource-action="create"
			resource-url="lot_trxs/CREATE/transaction">
		</things-ajax>

		<things-ajax
			id="latest-lots"
			resource-action="index"
			resource-url="lots"
			limit="10"
			last-response="{{latestLots}}">
		</things-ajax>

    <things-layout-hermes left-content-title="Lot Information" right-content-title="Latest Created Lot List">
      <things-diy-based-form
      	left-top
      	id="form"
      	class="flex"
      	resource="[[order]]"
      	resource-id="[[orderId]]"
      	diy-form-name="OI-CreateLot"
      	buttons="[[buttons]]">
      </things-diy-based-form>

	    <things-input-field
	    	left-bottom
	    	id="comments-form"
	    	label="Comments"
	    	value="{{comments}}">
    	</things-input-field>

      <things-diy-based-grid
      	right
      	class="flex"
      	diy-grid-name="OI-LatestLotList"
      	items="[[latestLots.items]]">
      </things-diy-based-grid>
    </things-layout-hermes>
	</template>

	<script>
		Polymer({
			
			is: 'things-term-create-lot',

			properties: {
				/**
				 * 메뉴 정보
				 */
				menuInfo: {
					type: Object
				},

				/**
				 * 라우팅 정보
				 */
				dataRoute: {
					type: String,
					observer: 'dataRouteChanged'
				},

				/**
				 * 오더
				 */
				order: {
					type: Object,
					notify: true
				},
				
				/**
				 * 오더 아이디
				 */
				orderId: {
					type: String
				},

				operationId: {
					type: String
				},

				/**
				 * 생성된 Lot
				 */
				lot: {
					type: Object
				},

				latestLots: {
					type: Object
				},

				comments: {
					type: String
				},

				/**
				* Buttons 리스트 설정
				*/
				buttons: {
					type: Array,
					value: [ {
						id: 'create-btn',
						text: 'create'
					}, {
						id: 'reset-btn',
						text: 'reset'
					} ]
				}
			},

			listeners: {
				'create-btn-tap' : 'createLot',
				'reset-btn-tap' : 'resetForm',
				'create-lot.things-ajax-response' : '_transactionResponsed',
			},

			behaviors: [
				Things.GlobalBehavior
			],

			observers: [
				'orderChanged(globals.order)',
				'operationChanged(globals.operation)'
			],

			orderChanged: function(order) {
				this.order = order;
				this.orderId = order.id;

				if(this.orderId) {
					this.getLatestLots();
				}
			},

			operationChanged: function(operation) {
				this.operation = operation;
				this.operationId = operation.id;
			},

			/**
			 * dataRoute가 변경되었을 경우 
			 *
			 * @param {String} dataRoute
			 */
			dataRouteChanged: function(dataRoute) {
				if(dataRoute == this.menuInfo.routing) {
					if(this.globals) {
						var dataGlobal = this.globals;
						this.operationId = (dataGlobal.operation.id) ? dataGlobal.operation.id : ''; 
						this.orderId = (dataGlobal.order.id) ? dataGlobal.order.id : '';
					}					
				}
			},			

			/**
			 * Create Lot 
			 */
			createLot: function() {
				var createAjax = this.$['create-lot'];
				var orderId = this.orderId;
				var operationId = this.operationId;
				var comments = this.$['comments-form'].value;

				if(orderId && orderId != '' && operationId && operationId != '') {
					createAjax.body = {
						work_order_id : orderId,
						comments : comments,
						operation_id : operationId
					};

					createAjax.generateRequest();
					this.getLatestLots();
				} else {
					console.error('Cannot create Lot!');
				}
			},

			getLatestLots: function() {
				this.$['latest-lots'].queryFields = [{
					name: 'work_order_id',
					value: this.orderId
				}, {
					name: 'state',
					value: 'CREATED'
				}];

				this.$['latest-lots'].sortFields = [{
					field: 'updated_at',
					ascending: false
				}];

				this.$['latest-lots'].generateRequest();
			},			

			/**
			 * Reset Form 
			 *
			 * @param {Object} event
			 */
			resetForm: function(event) {
				this.$['comments-form'].value = '';
				this.$['get-order'].generateRequest();
			},

			/**
			 * 트랜잭션 성공시 
			 *
			 * @param {Object} event
			 */
			_transactionResponsed: function(event) {
				this.resetForm();
				this.lot = event.detail;
			}
		});
	</script>
</dom-module>