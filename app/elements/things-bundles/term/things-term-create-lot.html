<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/things-tristate-radio/things-tristate-radio.html">

<link rel="import" href="../../things-meta-view/things-diy-based-form.html">
<link rel="import" href="../../things-label-print/things-print-agent.html">
<link rel="import" href="things-term-common-grid.html">

<!--
OI Screen - Order List
-->

<dom-module id="things-term-create-lot">
	<template>
		<style>
			:host {
				display: block;
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}
      things-layout-hermes {
        @apply(--layout-flex);
      }			
		</style>

		<things-ajax
			auto
			id="get-order"
			resource-action="find"
			resource-url="work_orders/:id"
			resource-id="[[orderId]]"
			last-response="{{order}}">
		</things-ajax>

		<things-ajax
			id="create-lot"
			resource-action="create"
			resource-url="lot_trxs/CREATE/transaction">
		</things-ajax>

		<things-ajax
			id="label-model"
			resource-action="find"
			resource-url="lots/:id/label">
		</things-ajax>

		<things-print-agent id="print-agent"></things-print-agent>

    <things-layout-hermes top-left-content-title="Lot Information" bottom-left-content-title="Comments" right-content-title="Latest Created Lot List">
      <things-diy-based-form
      	left-top
      	id="form"
      	class="flex"
      	resource="[[order]]"
      	resource-id="[[orderId]]"
      	diy-form-name="OI-CreateLot"
      	buttons="[[buttons]]">
      </things-diy-based-form>

	    <div left-bottom class="flex">
		    <things-input-field
		    	on-keypress="handleKeyPress"
		    	id="comments-form"
		    	label="Comments"
		    	value="{{comments}}">
	    	</things-input-field>

	    	<things-tristate-radio
	    		id="print"
	    		label="Print">
	    	</things-tristate-radio>	    	
    	</div>

      <things-term-common-grid
      	right
      	id="common-grid"
      	class="flex"
      	query-fields="[[queryFields]]"
      	sort-fields="[[sortFields]]">
      </things-term-common-grid>
    </things-layout-hermes>
	</template>

	<script>
		Polymer({
			
			is: 'things-term-create-lot',

			properties: {
				/**
				 * 메뉴 정보
				 */
				menuInfo: {
					type: Object
				},

				/**
				 * 라우팅 정보
				 */
				dataRoute: {
					type: String,
					observer: 'dataRouteChanged'
				},

				/**
				 * 오더
				 */
				order: {
					type: Object,
					notify: true
				},
				
				/**
				 * 오더 아이디
				 */
				orderId: {
					type: String
				},

				/**
				 * 생성된 Lot
				 */
				lot: {
					type: Object
				},

				/**
				 * create lot 시에 입력 받은 comment
				 */
				comments: {
					type: String
				},

				/**
				 * common-grid에 넘겨줄 query fields property
				 */
				queryFields: {
					type: Array
				},

				/**
				 * common-grid에 넘겨줄 sort fields property
				 */
				sortFields: {
					type: Array
				},

				/**
				* Buttons 리스트 설정
				*/
				buttons: {
					type: Array,
					value: [ {
						id: 'create-btn',
						text: 'create'
					}, {
						id: 'reset-btn',
						text: 'reset'
					} ]
				}
			},

			listeners: {
				'create-btn-tap' : 'createLot',
				'reset-btn-tap' : 'resetForm',
				'create-lot.things-ajax-response' : '_transactionResponsed',
				'label-model.things-ajax-response' : '_labelModelResponsed'
			},

			behaviors: [
				Things.GlobalBehavior
			],

			observers: [
				'orderChanged(globals.order)',
			],

			/**
			 * order가 변화하면 order와 orderId를 초기화 하고
			 * common-grid의 ajax를 호출 한다.
			 */
			orderChanged: function(order) {
				this.order = order;
				this.orderId = order.id;

				if(this.orderId) {
					this.getLatestLots();
				}
			},

			/**
			 * dataRoute가 변경되었을 경우 
			 *
			 * @param {String} dataRoute
			 */
			dataRouteChanged: function(dataRoute) {
				if(dataRoute == this.menuInfo.routing) {
					if(this.globals) {
						var dataGlobal = this.globals;
						this.orderId = (dataGlobal.order.id) ? dataGlobal.order.id : '';
					}					
				}
			},			

			/**
			 * key event - form submits when enter key is monitored
			 */
			handleKeyPress: function(event) {
				var code = event.keyCode;
				if(code == 13) {
					this.createLot();
				}
			},

			/**
			 * Create Lot 
			 */
			createLot: function() {
				if(!this.orderId) return;

				var createAjax = this.$['create-lot'];
				createAjax.body = {
					work_order_id : this.orderId,
					comments : this.$['comments-form'].value
				};

				createAjax.generateRequest();
			},

			/**
			 * queryFields와 sortFields를 초기화하고 
			 * 해당 property를 바탕으로 common-grid의 ajax 호출
			 */
			getLatestLots: function() {
				this.queryFields = [{
					name: 'work_order_id',
					value: this.orderId					
				}, {
					name: 'transaction',
					value: 'CREATE'			
				}];
				this.$['common-grid'].refreshData();
			},

			/**
			 * Reset Form 
			 *
			 * @param {Object} event
			 */
			resetForm: function(event) {
				this.$['comments-form'].value = '';
			},

			/**
			 * 트랜잭션 성공시 
			 *
			 * @param {Object} event
			 */
			_transactionResponsed: function(event) {
				this.getLatestLots();
				this.resetForm();
				this.fire('iron-signal', {name : 'refresh-wip'});
				this.lot = event.detail;
				
				if(this.$['print'].value == true) {
					// Get Label Model
					this.$['label-model'].resourceId = this.lot.id;
					this.$['label-model'].generateRequest();
				}
			},

			_labelModelResponsed: function(event) {
				var label = event.detail;
				var variableData = {
					'#{company_name}' : 'Hatio Lab.',
					'#{order_name}' : this.order.name,
					'#{product_model_name}' : this.order.product_model.name,
					'#{material_name}' : this.order.material.name,
					'#{material_desc}' : 'Material Desc',
					'#{work_date}' : this.lot.work_date,
					'#{lot_size}' : '' + this.lot.good_qty,
					'#{lot_name}' : this.lot.name
				};

				var agent = this.$['print-agent'];
				agent.label = label;
				agent.convertData = variableData;
				agent.printLabel();
			}
		});
	</script>
</dom-module>