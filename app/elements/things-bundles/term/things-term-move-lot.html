<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">

<link rel="import" href="../../things-meta-view/things-diy-based-grid.html">
<link rel="import" href="../../things-meta-view/things-diy-based-form.html">
<link rel="import" href="../../things-bundles/term/things-term-common-grid.html">

<!--
  OI - MOVE LOT 트랜잭션 
-->

<dom-module id="things-term-move-lot">
  <template>
    <style>
      :host {
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      things-layout-hermes {
        @apply(--layout-flex);
      }
    </style>

    <things-ajax
      id="find-lot"
      resource-action="find"
      last-response="{{lot}}">
    </things-ajax>

    <things-ajax
      id="move-lot"
      resource-action="create"
      resource-url="lot_trxs/MOVE/transaction">
    </things-ajax>

    <things-layout-hermes left-content-title="Lot Information" right-content-title="Latest Created Lot List">
      <things-diy-based-form 
        id="form"
        left-top
        class="flex"
        diy-form-name="OI-MoveLot"
        buttons="[[formButtons]]">
      </things-diy-based-form>
      
      <things-input-field
        left-bottom
        label="Comments"
        value="{{comments}}">
      </things-input-field>

      <things-term-common-grid
        right
        class="flex"
        id="common-grid">
      </things-term-common-grid>
    </things-layout-hermes>
  </template>

  <script>
    Polymer({
      is: 'things-term-move-lot',

      properties: {
        /**
         * 메뉴 정보
         */
        menuInfo: {
          type: Object
        },

        /**
         * 라우팅 정보
         */
        dataRoute: {
          type: String
        },

        /**
         * Title Of Left Content
         */
        leftContentTitle: {
          type: String,
          value: 'Lot Information'
        },

        /**
         * Title Of Right Content
         */
        rightContentTitle: {
          type: String,
          value: 'Latest Lot List'
        },

        /**
         * Lot
         */
        lot: {
          type: Object,
          observer: '_lotChanged'
        },

        lastResponse: {
          type: Array
        },

        /**
         * Form 버튼 
         */
        formButtons: {
          type: Array,
          value: function() {
            return [ {
              id: 'search-btn',
              text: 'search'
            }, {
              id: 'process-btn',
              text: 'process'
            }, {
              id: 'reset-btn',
              text: 'reset'
            } ];
          }
        }
      },

      listeners: {
        'search-btn-tap' : 'findLot',
        'process-btn-tap' : 'moveLot',
        'reset-btn-tap' : 'resetForm',
        'move-lot.things-ajax-response' : '_transactionResponsed',
      },

      behaviors: [
        Things.GlobalBehavior
      ],

      observers: [
        'orderChanged(globals.order)'
      ],

      orderChanged: function(order) {
        this.$['common-grid'].generateRequest();
      },

      /** 
       * Find Lot 
       *
       * @param {Object} event
       */
      findLot: function(event) {
        var data = this.$['form'].getForm().serializeMyForm();
        var findAjax = this.$['find-lot'];
        findAjax.resourceUrl = 'lots/show_by_name?name=' + data.name;
        findAjax.generateRequest();
      },

      /** 
       * Move Lot 
       *
       * @param {Object} event
       */
      moveLot: function(event) {
        var data = this.$['form'].getForm().serializeMyForm();
        var moveAjax = this.$['move-lot'];
        moveAjax.body = {
          lot_id : data.id,
          comments : data.comments,
          operation_id : data.operation_id
        };

        moveAjax.generateRequest();
      },

      /**
       * Reset Form 
       *
       * @param {Object} event
       */
      resetForm: function(event) {
        this.$['form'].getForm().resetMyForm();
      },

      /**
       * Lot 조회시
       *
       * @param {Object} lot
       */
      _lotChanged: function(lot) {
        this.$['form'].getForm().setFormData(lot);
      },

      /**
       * 트랜잭션 성공시 
       *
       * @param {Object} event
       */
      _transactionResponsed: function(event) {
        this.resetForm();
      }
    });
  </script>
</dom-module>