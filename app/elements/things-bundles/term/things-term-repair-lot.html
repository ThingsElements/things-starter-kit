<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../things-meta-view/things-diy-based-grid.html">
<link rel="import" href="../../things-meta-view/things-diy-based-form.html">

<link rel="import" href="things-term-common-grid.html">
<link rel="import" href="things-lot-based-transaction-behavior.html">

<!--
  OI - Repair Lot 트랜잭션 
-->

<dom-module id="things-term-repair-lot">
  <template>
    <style>
      :host {
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      things-layout-hermes {
        @apply(--layout-flex);
      }
    </style>

    <things-ajax
      id="validate-lot"
      resource-action="create"
      resource-url="lot_trxs/VALIDATE/transaction"
      last-response="{{lot}}">
    </things-ajax>

    <things-ajax
      id="transaction"
      resource-action="create"
      resource-url="[[transactionUrl]]">
    </things-ajax>

    <things-layout-hermes 
      top-left-content-title="[[lotInfoTitle]]" 
      bottom-left-content-title="[[inputTitle]]" 
      right-content-title="[[repairListTitle]]">
      
      <!-- repair search form -->
      <things-diy-based-form
        left-top
        on-keypress="handleKeyPress"
        id="lot-info-form"
        class="flex"
        diy-form-name="OI-LotInfo"
        buttons="[[repairSearchButtons]]">
      </things-diy-based-form>

      <!-- repair info form -->
      <things-diy-based-form
        left-bottom
        id="input-form"
        class="flex"
        buttons="[[repairResultButtons]]"
        diy-form-name="OI-Repair">
      </things-diy-based-form>

      <!-- repair list grid -->
      <things-term-common-grid
        right
        id="latest-lot-grid"
        class="flex"
        query-fields="[[latestLotQueryFields]]">
      </things-term-common-grid>      

    </things-layout-hermes>
  </template>

  <script>
    Polymer({
      is: 'things-term-repair-lot',
      
      behaviors: [
        Things.LotBasedTransactionBehavior
      ],

      properties: {
        /**
         * Title Of Lot Information
         */
        lotInfoTitle: {
          type: String,
          value: function() {
            return Things.DataGlobal.t('title.LotInformation')
          }
        },

        /**
         * Title Of Input
         */
        inputTitle: {
          type: String,
          value: function() {
            return Things.DataGlobal.t('title.Input')
          }
        },

        /**
         * Title Of Lot List
         */
        repairListTitle: {
          type: String,
          value: function() {
            return Things.DataGlobal.t('title.ReceivedRepairList')
          }
        },        

        /**
         * lot-info-form 에서 사용하는 button setting
         */
        repairSearchButtons: {
          type: Array,
          value: function() {
            return [{
              id: 'search-btn',
              text: 'search'
            }, {
              id: 'reset-btn',
              text: 'reset'
            }];
          }
        },

        /**
         * input-form 에서 사용하는 button setting
         */
        repairResultButtons: {
          type: Array,
          value: function() {
            return [{
              id: 'scrap-btn',
              text: 'scrap'
            }, {
              id: 'return-btn',
              text: 'return'
            }]
          }
        },

        /**
         * validate 후 전달 받는 lotInfo
         */
        lotInfo : {
          type: Object
        },

        /**
         * validate 후 전달 받는 repair
         */
        repair: {
          type: Object
        }
      },

      observers: [
        'lotListConditionsChanged(orderId,operationId)'
      ],

      listeners: {
        'scrap-btn-tap' : 'lotScrapped',
        'return-btn-tap' : 'lotReturned',
        'transaction.things-ajax-response' : 'transactionResponsed',
        'things-grid-configured' : 'latestLotGridConfigured'
      },

      /**
       * Life Cycle - Ready
       */
      ready: function() {
        this.transaction = 'REPAIR';
      },

      /**
       * Latest Lot List 검색 조건 변경시 
       *
       * @param {String} orderId
       * @param {String} operationId
       */
      lotListConditionsChanged: function(orderId, operationId) {
        this.latestLotQueryFields = [{
          name: 'work_order_id',
          value: orderId
        }, {
          name: 'operation_id',
          value: operationId
        }, {
          name: 'status',
          value: 'REPAIR'
        }, {
          name: 'state',
          value: 'REPAIRING'
        }];

        this.getLatestLotGrid().refreshData();
      },

      /**
       * Latest Lot Grid 변경시
       */
      latestLotGridConfigured: function(event) {
        this.getLatestLotGrid().refreshData();
      },

      /**
       * Lot Information Form
       */
      getLotInfoForm: function() {
        return this.$['lot-info-form'];
      },

      /**
       * Latest Lot List Grid
       */
      getLatestLotGrid: function() {
        return this.$['latest-lot-grid'];
      },

      /**
       * Validation Lot Service
       */
      getValidateLotService: function() {
        return this.$['validate-lot'];
      },

      /**
       * Transaction Lot Service
       */
      getTransactionLotService: function() {
        return this.$['transaction'];
      },

      /**
       * Lot Transaction
       */
      lotTransaction: function() {
        var inputData = this.$['input-form'].getForm().serializeMyForm();
        var lotData = this.getLotInfoForm().getForm().serializeMyForm();
        var tranAjax = this.getTransactionLotService();

        tranAjax.body = {
          lot_repair_id : this.repair.id,
          work_order_id : this.orderId,
          current_operation_id : this.operationId,
          lot_id : this.lotInfo.id,
          action_code : this.actionCode,
          repair_code : inputData.repair_code,
          comments : inputData.comments
        };

        tranAjax.generateRequest();
      },

      /**
       * 트랜잭션 성공시 
       *
       * @param {Object} event
       */
      transactionResponsed: function(event) {
        this.refreshLatestLots();
        this.resetForm();
        this.$['input-form'].getForm().resetMyForm();
        this.fire('iron-signal', {name : 'refresh-wip'});
        this.lotInfo = [];
        this.repair = [];
        this.actionCode = '';
      },

      /**
       * Enter event 발생시 data search
       */
      handleKeyPress: function(event) {
        var code = event.keyCode;

        if(code == 13) {
          this.validateLot();
        }
      },

      /**
       * Lot 조회시
       *
       * @param {Object} lot
       */
      lotChanged: function(data) {
        this.lotInfo = data.lot;
        this.repair = data.lot_repair;
        this.getLotInfoForm().getForm().setFormData(this.lotInfo);
        this.$['input-form'].getForm().setFormData(this.repair);
      },

      /**
       * Scrap btn 탭 발생 이벤트
       * actionCode를 scrap으로 초기화 후 lotTransaction 호출
       */
      lotScrapped: function() {
        this.actionCode = 'SCRAP';
        this.lotTransaction();
      },

      /**
       * return btn 탭 발생 이벤트
       * actionCode를 COMPLETE로 초기화 후 lotTransaction 호출
       */
      lotReturned: function() {
        this.actionCode = 'COMPLETE'
        this.lotTransaction();
      }
    });
  </script>
</dom-module>